<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰ç¾©å¸‚æ°£å€™è®Šé·å‹•æ…‹åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h1 { grid-column: 1 / -1; text-align: center; color: #333; margin-bottom: 30px; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls { 
            grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 30px; 
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .mode-switch { display: flex; gap: 10px; }
        .mode-switch button {
            padding: 10px 25px; border: none; cursor: pointer; font-size: 16px; border-radius: 20px;
            transition: 0.2s; font-weight: bold;
        }
        .btn-temp { background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }
        .btn-temp.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        .btn-rain { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .btn-rain.active { background: #2980b9; color: white; border-color: #2980b9; }

        /* åœ–è¡¨èˆ‡åœ°åœ– */
        #chart-container, #map-container { 
            background: white; height: 450px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            overflow: hidden;
        }
        
        /* æ»‘æ¡¿æ¨£å¼ */
        .slider-group { flex-grow: 1; max-width: 600px; }
        input[type=range] { width: 100%; margin-top: 10px; cursor: pointer; }
        .year-label { font-size: 28px; font-weight: 800; color: #2c3e50; min-width: 80px; display: inline-block; }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        #error-msg { 
            grid-column: 1/-1; color: #721c24; background-color: #f8d7da; 
            padding: 20px; border-radius: 8px; text-align: center; display: none; 
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“Š å˜‰ç¾©å¸‚æ°£å€™è·å¹³å‹•æ…‹å±•ç¤º</h1>

        <div id="error-msg"></div>

        <div class="controls" id="main-controls">
            <div class="mode-switch">
                <button id="btn-temp" class="active" onclick="setMode('temp')">ğŸŒ¡ï¸ æ°£æº«æ¨¡å¼</button>
                <button id="btn-rain" onclick="setMode('rain')">ğŸŒ§ï¸ é›¨é‡æ¨¡å¼</button>
            </div>
            <div class="slider-group">
                <label>è§€æ¸¬å¹´ä»½: <span id="year-display" class="year-label">----</span></label>
                <input type="range" id="year-slider" step="1" disabled>
            </div>
        </div>

        <div id="chart-container"></div>
        <div id="map-container"></div>
    </div>

    <script src="å˜‰ç¾©å¸‚æ°£è±¡ç«™/data/weather_data.js" onerror="handleLoadError()"></script>

    <script>
        // --- 1. åˆå§‹åŒ–æª¢æŸ¥ ---
        function handleLoadError() {
            const msg = document.getElementById('error-msg');
            msg.style.display = 'block';
            msg.innerHTML = `
                <h3>âš ï¸ ç„¡æ³•è®€å–è³‡æ–™æª”æ¡ˆ</h3>
                <p>è«‹ç¢ºèªä»¥ä¸‹äº‹é …ï¼š</p>
                <ol style="text-align:left; display:inline-block;">
                    <li>R è…³æœ¬æ˜¯å¦å·²æˆåŠŸåŸ·è¡Œä¸¦ç”¢ç”Ÿ <code>weather_data.js</code>ï¼Ÿ</li>
                    <li>è©²æª”æ¡ˆæ˜¯å¦ä½æ–¼ <code>å˜‰ç¾©å¸‚æ°£è±¡ç«™/data/</code> è³‡æ–™å¤¾å…§ï¼Ÿ</li>
                    <li>æœ¬ HTML æª”æ¡ˆæ˜¯å¦æ”¾åœ¨ <code>å˜‰ç¾©å¸‚æ°£è±¡ç«™</code> çš„ä¸Šä¸€å±¤ç›®éŒ„ï¼Ÿ</li>
                </ol>
            `;
        }

        // --- 2. å…¨åŸŸè®Šæ•¸ ---
        let rawData = null;
        let map = null;
        let markers = {};
        let currentMode = 'temp'; 
        let currentYear = 0;
        let yearsList = [];

        const COLORS = {
            temp: { high: '#e74c3c', low: '#27ae60' }, // ç´… / ç¶ 
            rain: { high: '#2980b9', low: '#8d6e63' }, // è— / æ£• (æ›´åƒä¹¾æ—±è‰²)
            nodata: '#e0e0e0'
        };

        // --- 3. ç¨‹å¼é€²å…¥é» ---
        window.onload = function() {
            if (typeof window.weatherData === 'undefined') {
                handleLoadError();
                return;
            }
            rawData = window.weatherData;
            initApp();
        };

        function initApp() {
            initMap();

            // æ•´ç†å¹´ä»½
            const yearsSet = new Set(rawData.records.map(r => r.year));
            yearsList = Array.from(yearsSet).sort((a, b) => a - b);
            
            // è¨­å®šæ»‘æ¡¿
            const slider = document.getElementById('year-slider');
            slider.min = yearsList[0];
            slider.max = yearsList[yearsList.length - 1];
            slider.value = yearsList[yearsList.length - 1]; // é è¨­æœ€æ–°å¹´
            slider.disabled = false;
            currentYear = parseInt(slider.value);

            // ç¶å®šäº‹ä»¶
            slider.addEventListener('input', (e) => {
                currentYear = parseInt(e.target.value);
                updateDashboard();
            });

            // å»ºç«‹åœ°åœ–æ¸¬ç«™é»
            rawData.metadata.forEach(st => {
                const marker = L.circleMarker([st.lat, st.lon], {
                    radius: 12,
                    fillOpacity: 1,
                    color: '#666',
                    weight: 2,
                    fillColor: COLORS.nodata
                }).bindPopup(`<b>${st.name}</b>`);
                
                marker.addTo(map);
                markers[st.id] = marker;
            });

            updateDashboard();
        }

        function initMap() {
            map = L.map('map-container').setView([23.475, 120.46], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-temp').className = mode === 'temp' ? 'active btn-temp' : 'btn-temp';
            document.getElementById('btn-rain').className = mode === 'rain' ? 'active btn-rain' : 'btn-rain';
            updateDashboard();
        }

        // --- 4. æ ¸å¿ƒæ›´æ–°é‚è¼¯ ---
        function updateDashboard() {
            document.getElementById('year-display').innerText = currentYear;
            
            const yearRecords = rawData.records.filter(r => r.year === currentYear);
            
            // è¨ˆç®—ç•¶å¹´åº¦ã€Œå€åŸŸå¹³å‡ã€(Spatial Average)
            let spatialSum = 0;
            let count = 0;
            yearRecords.forEach(r => {
                const val = currentMode === 'temp' ? r.avg_temp : r.total_rain;
                if(val != null) { spatialSum += val; count++; }
            });
            const spatialAvg = count > 0 ? spatialSum / count : 0;

            // A. æ›´æ–°åœ°åœ–
            rawData.metadata.forEach(st => {
                const record = yearRecords.find(r => r.station_id === st.id);
                const marker = markers[st.id];
                
                if (!record) {
                    marker.setStyle({ fillColor: COLORS.nodata, color: '#ccc' });
                    marker.setPopupContent(`<b>${st.name}</b><br>ç„¡è³‡æ–™`);
                } else {
                    const val = currentMode === 'temp' ? record.avg_temp : record.total_rain;
                    const diff = val - spatialAvg;
                    
                    // åˆ¤æ–·é¡è‰²
                    let color;
                    if (currentMode === 'temp') {
                        color = diff >= 0 ? COLORS.temp.high : COLORS.temp.low;
                    } else {
                        color = diff >= 0 ? COLORS.rain.high : COLORS.rain.low;
                    }

                    marker.setStyle({ fillColor: color, color: '#fff' });
                    
                    const unit = currentMode === 'temp' ? "Â°C" : "mm";
                    const diffStr = (diff > 0 ? "+" : "") + diff.toFixed(1);
                    marker.setPopupContent(`
                        <div style="text-align:center; font-size:14px;">
                            <strong style="font-size:16px;">${st.name}</strong><br>
                            æ•¸å€¼: ${val.toFixed(1)} ${unit}<br>
                            <span style="color:${color}; font-weight:bold;">(è·å¹³: ${diffStr})</span>
                        </div>
                    `);
                }
            });

            // B. æ›´æ–°é•·æ¢åœ– (Time Series Anomaly)
            updateChart();
        }

        function updateChart() {
            // è¨ˆç®—é•·æœŸçš„ã€Œç¸½æ°£å€™å¹³å‡ã€(æ‰€æœ‰å¹´ä»½ã€æ‰€æœ‰æ¸¬ç«™çš„å¹³å‡)
            // é€™æ¨£é•·æ¢åœ–é¡¯ç¤ºçš„æ‰æ˜¯ã€Œæ°£å€™è®Šé·ã€è¶¨å‹¢
            const globalAvg = currentMode === 'temp' ? rawData.climatology[0].global_avg_temp : rawData.climatology[0].global_avg_rain;

            // æº–å‚™æ¯å¹´æ•¸æ“š
            const x = [];
            const y = [];
            const colors = [];
            const opacities = [];
            
            yearsList.forEach(yr => {
                // ç®—è©²å¹´çš„å…¨å€å¹³å‡
                const recs = rawData.records.filter(r => r.year === yr);
                let sum = 0, n = 0;
                recs.forEach(r => {
                    const val = currentMode === 'temp' ? r.avg_temp : r.total_rain;
                    if(val) { sum += val; n++; }
                });
                
                if (n > 0) {
                    const yearAvg = sum / n;
                    const anomaly = yearAvg - globalAvg;
                    
                    x.push(yr);
                    y.push(anomaly);
                    
                    // é¡è‰²èˆ‡é€æ˜åº¦é‚è¼¯
                    let color;
                    if (currentMode === 'temp') {
                        color = anomaly >= 0 ? COLORS.temp.high : COLORS.temp.low;
                    } else {
                        color = anomaly >= 0 ? COLORS.rain.high : COLORS.rain.low;
                    }
                    colors.push(color);
                    
                    // é¸ä¸­çš„å¹´ä»½ä¸é€æ˜ï¼Œå…¶ä»–å¹´ä»½åŠé€æ˜
                    opacities.push(yr === currentYear ? 1 : 0.3);
                }
            });

            const unit = currentMode === 'temp' ? "Â°C" : "mm";
            
            const trace = {
                x: x,
                y: y,
                type: 'bar',
                marker: {
                    color: colors,
                    opacity: opacities
                }
            };

            const layout = {
                title: {
                    text: currentMode === 'temp' ? `æ­·å¹´æº«åº¦è·å¹³ (ç›¸å°æ–¼å¹³å‡ ${globalAvg.toFixed(1)}${unit})` : `æ­·å¹´é™é›¨è·å¹³ (ç›¸å°æ–¼å¹³å‡ ${globalAvg.toFixed(0)}${unit})`,
                    font: { size: 18 }
                },
                margin: { t: 40, l: 50, r: 20, b: 40 },
                xaxis: { title: 'å¹´ä»½', tickangle: -45 },
                yaxis: { title: `è·å¹³ (${unit})` }
            };

            Plotly.newPlot('chart-container', [trace], layout, {responsive: true});
        }
    </script>
</body>
</html>