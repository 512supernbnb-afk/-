<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å˜‰ç¾©å¸‚æ°£å€™è®Šé·å‹•æ…‹åœ°åœ–</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h1 { grid-column: 1 / -1; text-align: center; color: #333; margin-bottom: 30px; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls { 
            grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 30px; 
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .mode-switch { display: flex; gap: 10px; }
        .mode-switch button {
            padding: 10px 25px; border: none; cursor: pointer; font-size: 16px; border-radius: 20px;
            transition: 0.2s; font-weight: bold;
        }
        .btn-temp { background: #ffebee; color: #c0392b; border: 1px solid #ffcdd2; }
        .btn-temp.active { background: #e74c3c; color: white; border-color: #e74c3c; }
        .btn-rain { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .btn-rain.active { background: #2980b9; color: white; border-color: #2980b9; }

        /* åœ–è¡¨èˆ‡åœ°åœ– */
        #chart-container, #map-container { 
            background: white; height: 450px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        }
        
        /* æ»‘æ¡¿æ¨£å¼ */
        .slider-group { flex-grow: 1; max-width: 600px; }
        input[type=range] { width: 100%; margin-top: 10px; cursor: pointer; }
        .year-label { font-size: 28px; font-weight: 800; color: #2c3e50; min-width: 80px; display: inline-block; }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        #error-msg { 
            grid-column: 1/-1; color: #721c24; background-color: #f8d7da; 
            padding: 20px; border-radius: 8px; text-align: center; display: none; 
        }

        /* --- æ–°å¢ï¼šåœ°åœ–æ¸¬ç«™æ¨™ç±¤æ¨£å¼ --- */
        .station-label {
            background: transparent !important; /* å»æ‰é è¨­ç™½åº• */
            border: none !important;            /* å»æ‰é‚Šæ¡† */
            box-shadow: none !important;        /* å»æ‰é™°å½± */
            color: #333;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 2px 2px 2px white, -2px -2px 2px white, 2px -2px 2px white, -2px 2px 2px white; /* ç™½é‚Šæ•ˆæœç¢ºä¿å¯è®€æ€§ */
            margin-top: 5px; /* èˆ‡åœ“é»çš„è·é›¢ */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ“Š å˜‰ç¾©å¸‚æ°£å€™è®Šé·å‹•æ…‹å±•ç¤º</h1>

        <div id="error-msg"></div>

        <div class="controls" id="main-controls">
            <div class="mode-switch">
                <button id="btn-temp" class="active" onclick="setMode('temp')">ğŸŒ¡ï¸ æ°£æº«æ¨¡å¼</button>
                <button id="btn-rain" onclick="setMode('rain')">ğŸŒ§ï¸ é›¨é‡æ¨¡å¼</button>
            </div>
            <div class="slider-group">
                <label>è§€æ¸¬å¹´ä»½: <span id="year-display" class="year-label">----</span></label>
                <input type="range" id="year-slider" step="1" disabled>
            </div>
        </div>

        <div id="chart-container"></div>
        <div id="map-container"></div>
    </div>

    <script src="å˜‰ç¾©å¸‚æ°£è±¡ç«™/data/weather_data.js" onerror="handleLoadError()"></script>

    <script>
        function handleLoadError() {
            const msg = document.getElementById('error-msg');
            msg.style.display = 'block';
            msg.innerHTML = `<h3>âš ï¸ ç„¡æ³•è®€å–è³‡æ–™æª”æ¡ˆ</h3><p>è«‹ç¢ºèª weather_data.js è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚</p>`;
        }

        let rawData = null;
        let map = null;
        let markers = {};
        let currentMode = 'temp'; 
        let currentYear = 0;
        let yearsList = [];

        const COLORS = {
            temp: { high: '#e74c3c', low: '#27ae60' }, 
            rain: { high: '#2980b9', low: '#8d6e63' }, 
            nodata: '#bdc3c7'
        };

        window.onload = function() {
            if (typeof window.weatherData === 'undefined') {
                handleLoadError();
                return;
            }
            rawData = window.weatherData;
            initApp();
        };

        function initApp() {
            initMap();

            const yearsSet = new Set(rawData.records.map(r => r.year));
            yearsList = Array.from(yearsSet).sort((a, b) => a - b);
            
            const slider = document.getElementById('year-slider');
            slider.min = yearsList[0];
            slider.max = yearsList[yearsList.length - 1];
            slider.value = yearsList[yearsList.length - 1];
            slider.disabled = false;
            currentYear = parseInt(slider.value);

            slider.addEventListener('input', (e) => {
                currentYear = parseInt(e.target.value);
                updateDashboard();
            });

            // åˆå§‹åŒ–åœ°åœ–æ¨™è¨˜ (å«æ–°å¢çš„ Tooltip æ¨™ç±¤)
            rawData.metadata.forEach(st => {
                const marker = L.circleMarker([st.lat, st.lon], {
                    radius: 14, // ç¨å¾®åŠ å¤§ä¸€é»é»ï¼Œæ¯”è¼ƒæ˜é¡¯
                    fillOpacity: 0.9,
                    color: '#666',
                    weight: 1,
                    fillColor: COLORS.nodata
                });
                
                // 1. ç¶å®šå½ˆå‡ºè¦–çª— (é»æ“Šæ™‚é¡¯ç¤ºè©³ç´°è³‡è¨Š)
                marker.bindPopup(`<b>${st.name}</b>`);
                
                // 2. æ–°å¢ï¼šç¶å®šæ°¸ä¹…é¡¯ç¤ºçš„æ¨™ç±¤ (Tooltip)
                marker.bindTooltip(st.name, {
                    permanent: true,    // æ°¸é é¡¯ç¤º
                    direction: 'bottom', // é¡¯ç¤ºåœ¨åœ“é»ä¸‹æ–¹
                    className: 'station-label', // å¥—ç”¨ CSS å»é™¤èƒŒæ™¯æ¡†
                    offset: [0, 5]      // å¾®èª¿ä½ç½®
                });
                
                marker.addTo(map);
                markers[st.id] = marker;
            });

            updateDashboard();
        }

        function initMap() {
            map = L.map('map-container').setView([23.475, 120.46], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-temp').className = mode === 'temp' ? 'active btn-temp' : 'btn-temp';
            document.getElementById('btn-rain').className = mode === 'rain' ? 'active btn-rain' : 'btn-rain';
            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('year-display').innerText = currentYear;
            
            const yearRecords = rawData.records.filter(r => r.year === currentYear);
            
            // è¨ˆç®—ç•¶å¹´åº¦å€åŸŸå¹³å‡
            let spatialSum = 0;
            let count = 0;
            yearRecords.forEach(r => {
                const val = currentMode === 'temp' ? r.avg_temp : r.total_rain;
                if(val != null) { spatialSum += val; count++; }
            });
            const spatialAvg = count > 0 ? spatialSum / count : 0;

            // æ›´æ–°åœ°åœ–é¡è‰²
            rawData.metadata.forEach(st => {
                const record = yearRecords.find(r => r.station_id === st.id);
                const marker = markers[st.id];
                
                if (!record) {
                    marker.setStyle({ fillColor: COLORS.nodata, color: '#999' });
                    marker.setPopupContent(`<b>${st.name}</b><br>ç„¡è³‡æ–™`);
                } else {
                    const val = currentMode === 'temp' ? record.avg_temp : record.total_rain;
                    const diff = val - spatialAvg;
                    
                    let color;
                    if (currentMode === 'temp') {
                        color = diff >= 0 ? COLORS.temp.high : COLORS.temp.low;
                    } else {
                        color = diff >= 0 ? COLORS.rain.high : COLORS.rain.low;
                    }

                    marker.setStyle({ fillColor: color, color: '#fff' });
                    
                    const unit = currentMode === 'temp' ? "Â°C" : "mm";
                    const diffStr = (diff > 0 ? "+" : "") + diff.toFixed(1);
                    // å½ˆå‡ºè¦–çª—å…§å®¹ä¹ŸåŒæ­¥ç™½è©±åŒ–
                    marker.setPopupContent(`
                        <div style="text-align:center;">
                            <strong style="font-size:16px;">${st.name}</strong><br>
                            æ•¸å€¼: ${val.toFixed(1)} ${unit}<br>
                            <span style="color:${color}; font-weight:bold;">(æ¯”å…¨å€å¹³å‡ ${diffStr})</span>
                        </div>
                    `);
                }
            });

            updateChart();
        }

        function updateChart() {
            const globalAvg = currentMode === 'temp' ? rawData.climatology[0].global_avg_temp : rawData.climatology[0].global_avg_rain;
            const unit = currentMode === 'temp' ? "Â°C" : "mm";
            
            // æ±ºå®š Y è»¸çš„è¦ªæ°‘åç¨±
            const yAxisLabel = `èˆ‡å¹³å‡å€¼çš„å·®ç•° (${unit})`;

            const x = [];
            const y = [];
            const colors = [];
            const opacities = [];
            
            yearsList.forEach(yr => {
                const recs = rawData.records.filter(r => r.year === yr);
                let sum = 0, n = 0;
                recs.forEach(r => {
                    const val = currentMode === 'temp' ? r.avg_temp : r.total_rain;
                    if(val) { sum += val; n++; }
                });
                
                if (n > 0) {
                    const yearAvg = sum / n;
                    const anomaly = yearAvg - globalAvg;
                    
                    x.push(yr);
                    y.push(anomaly);
                    
                    let color;
                    if (currentMode === 'temp') {
                        color = anomaly >= 0 ? COLORS.temp.high : COLORS.temp.low;
                    } else {
                        color = anomaly >= 0 ? COLORS.rain.high : COLORS.rain.low;
                    }
                    colors.push(color);
                    opacities.push(yr === currentYear ? 1 : 0.3);
                }
            });

            const trace = {
                x: x,
                y: y,
                type: 'bar',
                marker: {
                    color: colors,
                    opacity: opacities
                }
            };

            const layout = {
                title: {
                    // æ¨™é¡Œä¹Ÿå¯«å¾—æ›´è©³ç´°ä¸€é»
                    text: currentMode === 'temp' ? 
                        `æ­·å¹´æ°£æº«è®ŠåŒ– (é•·æœŸå¹³å‡: ${globalAvg.toFixed(1)}${unit})` : 
                        `æ­·å¹´é›¨é‡è®ŠåŒ– (é•·æœŸå¹³å‡: ${globalAvg.toFixed(0)}${unit})`,
                    font: { size: 18 }
                },
                margin: { t: 50, l: 60, r: 20, b: 60 }, // ä¸‹æ–¹é‚Šç•Œ (b) åŠ å¤§ï¼Œçµ¦ X è»¸æ¨™ç±¤ç©ºé–“
                xaxis: { 
                    title: {
                        text: 'å¹´ä»½',
                        standoff: 20 // æ–°å¢ï¼šé€™å°±æ˜¯è®“ã€Œå¹´ä»½ã€å¾€ä¸‹ä¸€é»çš„ç¥å¥‡åƒæ•¸
                    },
                    tickangle: -45 
                },
                yaxis: { 
                    title: yAxisLabel // æ–°å¢ï¼šä½¿ç”¨ç™½è©±æ–‡ Y è»¸
                }
            };

            Plotly.newPlot('chart-container', [trace], layout, {responsive: true});
        }
    </script>
</body>
</html>
